<!DOCTYPE html>
<html>
  <head><title>ValueTube</title></head>
  <body>
    <script src="https://apis.google.com/js/api.js"></script>
    <script>
      var GoogleAuth;
      var SCOPE = 'https://www.googleapis.com/auth/youtube.force-ssl';
      function handleClientLoad() {
        // Load the API's client and auth2 modules.
        // Call the initClient function after the modules load.
        gapi.load('client:auth2', initClient);
      }
    
      function initClient() {
        // Retrieve the discovery document for version 3 of YouTube Data API.
        // In practice, your app can retrieve one or more discovery documents.
        var discoveryUrl = 'https://www.googleapis.com/discovery/v1/apis/youtube/v3/rest';
    
        // Initialize the gapi.client object, which app uses to make API requests.
        // Get API key and client ID from API Console.
        // 'scope' field specifies space-delimited list of access scopes.
        gapi.client.init({
            'apiKey': 'AIzaSyDH3-W6b_8zwDbf9_gOgCoueqCG_fr1kFk',
            'clientId': '678353975875-shl86pdiisrgg91dmck4pe4h1l8vdiul.apps.googleusercontent.com',
            'discoveryDocs': [discoveryUrl],
            'scope': SCOPE
        }).then(thing());
        function thing() {
          
          GoogleAuth = gapi.auth2.getAuthInstance();
    
          // Listen for sign-in state changes.
          GoogleAuth.isSignedIn.listen(updateSigninStatus);
          
          // Handle initial sign-in state. (Determine if user is already signed in.)
          var user = GoogleAuth.currentUser.get();
          setSigninStatus();
          console.log(user);
    
          // Call handleAuthClick function when user clicks on
          //      "Sign In/Authorize" button.
          $('#sign-in-or-out-button').click(function() {
            handleAuthClick();
          });
          $('#revoke-access-button').click(function() {
            revokeAccess();
          });
        }
      }
    
      function handleAuthClick() {
        if (GoogleAuth.isSignedIn.get()) {
          // User is authorized and has clicked "Sign out" button.
          console.log("clicked so");
          GoogleAuth.signOut();
        } else {
          // User is not signed in. Start Google auth flow.
          console.log("clicked si");
          GoogleAuth.signIn();
        }
      }
    
      function revokeAccess() {
        GoogleAuth.disconnect();
      }
    
      function setSigninStatus(isSignedIn) {
        var user = GoogleAuth.currentUser.get();
        var isAuthorized = user.hasGrantedScopes(SCOPE);
        console.log(user);
        console.log("Authorised: " + isAuthorized)
        if (isAuthorized) {
          $('#sign-in-or-out-button').html('Sign out');
          $('#revoke-access-button').css('display', 'inline-block');
          $('#auth-status').html('You are currently signed in and have granted ' +
              'access to this app.');
        } else {
          $('#sign-in-or-out-button').html('Sign In/Authorize');
          $('#revoke-access-button').css('display', 'none');
          $('#auth-status').html('You have not authorized this app or you are ' +
              'signed out.');
        }
      }
    
      function updateSigninStatus(isSignedIn) {
        setSigninStatus();
      }
    </script>
    
    <button id="sign-in-or-out-button"
            style="margin-left: 25px">Sign In/Authorize</button>
    <button id="revoke-access-button"
            style="display: none; margin-left: 25px">Revoke access</button>
    
    <div id="auth-status" style="display: inline; padding-left: 25px"></div><hr>
    
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <script async defer src="https://apis.google.com/js/api.js"
            onload="this.onload=function(){};handleClientLoad()"
            onreadystatechange="if (this.readyState === 'complete') this.onload()">
    </script>
    <script>
      
      vidArr = [];

      function execute(vidId) {
        return gapi.client.youtube.videos.list({
          "part": "snippet,contentDetails,statistics",
          "id": vidId
        })
            .then(function(response) {
                    console.log("Response", response);
                    showVid(response["result"]);
                    createObj(response["result"]["items"][0])
                  },
                  function(err) { console.error("Execute error", err); });
      }

      function showVid(vid) {
        let snip = vid["items"][0]["snippet"];
        let img = document.createElement("img");
        img.src = snip["thumbnails"]["medium"]["url"];
        document.getElementById("vidDisplay").appendChild(img);

        let title = document.createElement("h3");
        title.innerText = snip["channelTitle"] + " -> " + snip["title"];
        document.getElementById("vidDisplay").appendChild(title);

        let p = document.createElement("p");
        p.innerText = snip["description"].substr(0,300);
        document.getElementById("vidDisplay").appendChild(p);
      }

      function executeSearch(term) {
        return gapi.client.youtube.search.list({
          "part": "snippet",
          "maxResults": 10,
          "type": "video",
          "q": term
        })
            .then(function(response) {
                    // Handle the results here (response.result has the parsed body).
                    console.log("Response", response);
                    for (let res of response["result"]["items"]) {
                      execute(res["id"]["videoId"]);
                    }
                    console.log(vidArr);
                  },
                  function(err) { console.error("Execute error", err); });
      }

      function createObj(vid) {
        let snip = vid["snippet"];
        let stats = vid["statistics"];
        let videoData = {
          title: snip["title"],
          description: snip["description"],
          channelTitle: snip["channelTitle"],
          tags: snip["tags"],
          categoryId: snip["categoryId"],
          licencedContent: vid["contentDetails"]["licensedContent"],
          viewCount: stats["viewCount"],
          likeCount: stats["likeCount"],
          dislikeCount: stats["dislikeCount"],
          commentCount: stats["commentCount"]
        }
        vidArr.push(videoData);
      }

      function clearDiv() {
        document.getElementById("vidDisplay").innerHTML = "";
      }

    </script>
    <!-- <button onclick="authenticate().then(loadClient)">Authorize</button><br> -->
    <label for="vidID">Search: </label><input type="text" id="vidSearch">
    <button onclick="executeSearch(document.getElementById('vidSearch').value)">Search All</button><br>
    <label for="vidID">Video ID: </label><input type="text" id="vidID">
    <button onclick="execute(document.getElementById('vidID').value); console.log(vidArr)">Search by Vid ID</button><br>
    <button onclick="clearDiv()">Clear</button>
    <br>
    <div id="vidDisplay"></div>
  </body>
</html>